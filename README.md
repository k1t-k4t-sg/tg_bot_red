## Сборка

#### 1.1 В корневым каталоге отредактируйте `auth.json` и `gate.json`

`auth.json` отвечает за авторизацию в системе росдомофон и Telegram

```JSON

{
	"apiUrl": "https://rdba.rosdomofon.com",
	"resource": "/authserver-service/oauth/token",
	"auth": [
		{
			"client_id": "machine",
			"username": "USERNAME",
			"grant_type": "password",
			"password": "PASS"
		}
	],
	"admin": "TOKEN API TELEGRAM",
	"user": [
		"BOT ACCESS USERS"
	]
}

```

Замените `"username": "USERNAME",` на имя пользователя в rosdomofon.com <br>
Замените `"password": "PASS"` на пароль пользователя в rosdomofon.com <br>
Замените `"admin": "TOKEN API TELEGRAM"` на token telegram <br>
Поле `user` служит для доступа пользователей к боту
<br>
<br>

`gate.json` отвечает за статические адреса доступа к домофонии

```JSON

{
    "0190": {
        "ID": "",
        "Vendor": "Beward DKS (DTMF-открытие при вызове)",
        "Adress": "Улица Пушкина, дом Колотушкина",
        "URL": "http://login:pass@192.168.0.10:8080",
        "FlatStart": 0,
        "FlatEnd": 0
    }
}

```

#### 1.2 Создайте docker image

`sudo docker build --tag bot_red .`

#### 1.3 Запуск контенера <br>

```sh
sudo docker run --name "Domofonred" --restart always -d -v ./auth.json:/go/auth.json -v ./gate.json:/go/gate.json  bot_red
```
При запуске необходимо прокинуть auth.json и gate.json в корневой каталог проекта

## Документация по работе с @DomofonRed_bot

Для доступа к боту обратитесь к администратору.

Данная документация доступна только для моделей Beward

### 1. Доступные параметры при выборе домофона
- `ID` - Идентификатор в системе россдомофон
- `Numbering` - Нумерация квартир
- `AnswerLevel` - Общий уровень поднятия трубки
- `DoorLevel` - Общий уровень нажатия кнопки
- `DoorIime` - Время открытия двери
- `MainDoor=AltDoor` - Состояние замков ***(included-включен) (disconnected-отключен)***
- `Uptime` - Время работы домофона (дата.час:мин:сек)
- `Error` - Сообщение об ошибке в работе домофона, счетчик собирает данные с syslog
- `Label` - ***(только mifare)*** Количество записанных ключей
- `ScanCode` - Код и состояние сканирования ключей, если указан код и параметр ***=>on***, вы можете добавить ключи по набору кода
- `KeyReverse` - ***(только mifare)*** Порядок сканирования ключей (off-обратный), (on-прямой)
- `DoorCode` - Доступна ли функция открытия двери по коду ***(=>on доступен) (=>off не доступен)***
  
### 1.1 Параметры при выборе квартиры

- `Apartament` - Номер квартиры
- `Level` - Уровень линии до квартиры
- `KKM` - Кросс данные
- `Active CMS` - Разрешение на выполнение звонков и дублирование звонка на CMS
- `Block CMS` - Блокировка вызова в квартиру
- `PhoneX` - Сопоставление квартиры для службы
- `UP Level` - Индивидуальный уровень поднятия трубки
- `Open Level` - Индивидуальный уровень нажатия кнопки

### 1.2 Доступные функции

- `List` - Список установленных домофонов на сети
- `D-{}` - Выбрать домофон для дальнейшей операции
- `Open` - Открыть основную и дополнительную дверь
- `Full` - Основные переменные домофона
- `Log`  - log журнал
- `Key`  - Включить сканирование ключей
- `Get`  - Запросить последний записанный ключ 
- `L-{}` - Запросить проверку линии до квартиры
- `Dial-{}` - Выполнить тестовый звонок
- `{addr}` - Поиск адреса
- `add-{key}` - Добавить ключ на все панели

### 1.3 Порядок работы с ботом
#### 1.3.1 Выбор панели

Для начала работы введите первые три буквы адреса.

Результатом будет отправлено все похожие адреса и их **ID**

```sh
=> Муз
18948  Музыкина д.4 Под 1 
18949  Музыкина д.4 Под 2 
18950  Музыкина д.4 Под 3 

```

Для выбора панели введите префикс (**D-**) и (**ID номер**) панели 

Например: У адреса Музыкина д.4 Под 1, команда будет **(D-18948)**

```sh
=> D-18948

ID:     18948
Addr:   Музыкина д.4 Под 1
Uptime: 12.14:22:12
Error:  5
Label:  127 key

   Numbering: 1-40
 AnswerLevel: 330
   DoorLevel: 430

    ScanCode: 0=>off
  KeyReverse: off

    DoorCode: 12345=>on
    MainDoor: included
     AltDoor: included

```


Для описания параметров обратитесь к разделу ```1```.
После выбора панели вам доступны функции:
- `Open` - `Full` - `Log`- `Key` - `Get` - `L-{}`- `add-{key}`

#### 1.3.1 Выбор квартиры
По диапазону ```Numbering``` выберете квартиру командой `L-номер квартиры`.

Например, для выбора 1 квартиры по адресу Музыкина д.4 Под 1, наберите: `L-1`

```sh
=> L-1

Apartament: 1
     Level: 562
       KKM: KKM1 E1|D0 = 1.Apar 

Active CMS: on
 Block CMS: off
    Phone1: 1

  UP Level: 330
Open Level: 430

```
Для описания параметров обратитесь к разделу ```1.1```.
После выбора квартиры вам доступны функции:
- `L-{}` - `Dial-квартира` 

### 1.4 Диагностика подключения панели
#### 1.4.1 Параметр ```Uptime```

Данное значение определяет время работы домофона в формате (дата.час:мин:сек) если значение времени слишком маленькое то может указывать на проблему с основным питание, недавней перезагрузкой или замыкание в слаботочной сети. При замыкании, панель уходить в перезагрузку, что может способствовать сбросу настроек

#### 1.4.2 Параметр ```Error```

Сообщения об ошибке собираются с log журнала домофона методом общего подсчета события ```</ ERROR>```,
если вы наблюдаете большое количество зарегистрированных ошибок, запросите команду  ```log``` для диагностики и/или передайте проблему в ОСБ

#### 1.4.3 Параметр ```Label```

Количество записанных ключей, в случае нулевого значения может указывать на сброс настроек домофона, или в базе нет ключей 

#### 1.4.4 Параметр ```MainDoor``` и ```AltDoor```

Указывает на состояние замков, в нормальном режиме работы состояние замков в положение (```included```-включен).
В отключенном состояние параметр будет указывать (```disconnected```-отключен). Обычно отключенные замки задаются программно в новостройках, в остальных случаях передайте проблему в ОСБ

### 1.5 Диагностика подключения трубки

В время подключения трубки особое внимание стоит уделить какие цвета используется на коробке, при расключении коробок на клемах `D` используется однотонные цвета, на клемах `E` комбинация цветов (бело-зеленый, бело-оранжевый) и т.д 

Схема распиновки :

![Image alt](https://github.com/stepanger/bot/blob/main/DE.jpg?raw=true)

Если при проверки уровня значение указывают на ее отсутствие, по возможности передайте фото коробки в ОСБ

#### 1.5.1 Параметр ``` Level```
Цифровое напряжение трубки в сети. В время проверки уровня, домофон посылает короткий импульс имитирующий вызов на трубку. Нормальным значение варьируется от 200 до 300 с небольшой погрешностью, в остальных случаях трубка не подключена или повреждена магистраль, плохой контакт. При обнаружении уровня 200-300 с отключенной трубкой указывают на параллельное подключение второй трубки,  данная проблема указывает на повреждение магистрали, передайте проблему на ОСБ. 

#### 1.5.2 Параметр ``` KKM```
Данные кроссировки загружаются с пресета домофона, значения ```KKM1``` ```KKM2``` ```KKM3``` указывает какая сотня, используется в вашем подключение. 
#### 1.5.3 Параметр ``` Active CMS```
Разрешает переадресацию вызова на сторонние сервисы, в случае значения OFF. Звонки в приложения поступать не будут
#### 1.5.4 Параметр ``` Block CMS```
Блокировка вызова на трубку и сторонние сервисы. Звонки в приложения поступать не будут
#### 1.5.5 Параметр ``` Phone1 ```
Сопоставление квартиры для сторонних сервисов, если значение не указано, звонки в приложение поступать не будут
#### 1.5.6 Параметр ``` UP Level```
Индивидуальный уровень поднятия трубки
#### 1.5.7 Параметр ``` Open Level```
Индивидуальный уровень нажатия кнопки на трубке

### 1.6 Добавление ключей

Данная функция доступна в трех вариантах:
- По набору кода, если активен параметр `ScanCode`
- Команда `key`, активация сканирование ключей
- Команда `add-{key}`, массовая запись ключа на все домофоны
  
Для начало работы выберети домофон командой (например: **(D-18948)**)

```sh
=> D-18948

ID:         18948
Addr:       Музыкина д.4 Под 1
ScanCode:   12345=>on
KeyReverse: off

```

#### 1.6.1 Запись ключа с помощью параметра `ScanCode` 

Если значение `ScanCode`  указан код и состояние on (`12345=>on`), набирите код на домофоне, на экране домофона появится надпись (поднесите ключ) запишите ключ и дождитесь завершения записи.

В случае значения (`12345=>off`) или (`0=>off`) запись через код отключена
Данный метод в основном используется на старых версиях ПО Beward.

#### 1.6.2 Запись ключа с помощью команды `Key` 
На новых версиях Beward доступна API команда на активацию записи, выберети домофон из списка, отправьте команду `Key` с бота и запишите ключ.

#### 1.6.2 Запись ключа `add-{key}` на все зарегестрированные домофоны.
Для начала работы вам необходимо определить идентификатор вашего ключа, для этого необходимо запись ключа по пункту `1.6.2`. Убедитесь что ключ записан и ошибки на домофоне не появились, двери с нового ключа открываются.

- Запросите последний записанный ключ командой `get`

- Скопируйте полученный идентификатор (например: `00000A0F6635`)
  
- Введите в сообщении префикс `add-` и идентификатор (например: `add-00000A0F6635`)
- Отправте команду боту 
- В базе данных домофона ваш ключ запишеться под иминем `(TG ник_в_телеграмм дата_записи)`

#### Внимание!
#### Будьте внемательны при совершении данной операции, не правельно записанный ключ работать не будет, и вызовет ошибку на всех домофонах, если вы не уверены в действии запросите информацию/помощь у ОСБ.
Некоторые моменты:
- Повторно записанный ключи с ошибкой регестрируется в log как
`Unable to add User Mifare CLASSIC key {key}, already exists with index {index}`

- Данная функция выполняется многопоточно, в основном время выполнения 3-10сек. на домофоны с поддержкой rfid ключ не запишется
- Резервная копия ключа не сохраняется 


